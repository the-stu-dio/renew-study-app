<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Negative Events - Interactive Cards</title>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Work Sans', sans-serif;
      background-color: #f4f0fb;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }

    .before-button {
      position: fixed;
      top: 20px;
      left: 20px;
      color: #5a3e8c;
      background: #c8b5db;
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #b8a5d1;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      z-index: 10;
      text-decoration: none;
      display: inline-block;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }

    .before-button:hover {
      background: #b8a5d1;
      color: #4a3474;
      text-decoration: none;
    }

    .next-button-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10;
    }

    .next-button-overlay {
      background: #c8b5db;
      color: #5a3e8c;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #b8a5d1;
      transition: all 0.2s ease;
      display: inline-block;
      font-family: 'Work Sans', sans-serif;
      position: relative;
    }

    .next-button-overlay:hover {
      background: #b8a5d1;
      color: #4a3474;
      text-decoration: none;
      transform: translateY(-1px);
    }

    /* Motivational entrance animation - Purple to White */
    .next-button-motivational {
      animation: motivationalEntrance 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    @keyframes motivationalEntrance {
      0% {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
        box-shadow: 0 0 0 rgba(255, 255, 255, 0);
        background: #c8b5db;
      }
      20% {
        opacity: 0.7;
        transform: translateX(-10px) scale(1.05);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
      }
      40% {
        opacity: 1;
        transform: translateX(5px) scale(1.1);
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.9);
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
      }
      60% {
        transform: translateX(-2px) scale(1.02);
        box-shadow: 0 4px 20px rgba(255, 255, 255, 0.7);
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
      }
      80% {
        transform: translateX(1px) scale(1.01);
        box-shadow: 0 4px 15px rgba(248, 249, 250, 0.5);
        background: linear-gradient(135deg, #f8f9fa, #c8b5db);
      }
      100% {
        opacity: 1;
        transform: translateX(0) scale(1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        background: #c8b5db;
      }
    }

    /* Motivational pulse effect for ongoing engagement */
    .next-button-pulse {
      position: relative;
      animation: motivationalPulse 2s ease-in-out infinite;
    }

    @keyframes motivationalPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4);
      }
    }

    /* Motivational glow border effect */
    .next-button-pulse::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffffff, #f8f9fa, #e9ecef, #ffffff);
      border-radius: 10px;
      z-index: -1;
      opacity: 0;
      animation: motivationalGlow 2s ease-in-out infinite;
    }

    @keyframes motivationalGlow {
      0%, 100% {
        opacity: 0;
      }
      50% {
        opacity: 0.4;
      }
    }

    /* Static visible state - no ongoing animation */
    .next-button-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    /* Hidden audio element - no visible UI */
    .hidden-audio {
      display: none;
    }

    /* Background audio player - hidden but functional */
    #backgroundAudio {
      display: none;
    }

    /* Card audio players - hidden but functional */
    .card-audio {
      display: none;
    }

    /* Modal audio players - hidden but functional */
    .modal-audio {
      display: none;
    }

    .container {
      max-width: 1200px;
      margin: 80px auto 20px;
      padding: 0 20px;
    }

    .intro-text {
      text-align: center;
      color: #5a3e8c;
      font-size: 18px;
      margin-bottom: 40px;
      line-height: 1.6;
    }

    .flip-cards-wrapper_top, .flip-cards-wrapper_bottom {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .flip-card-container {
      perspective: 1000px;
      cursor: pointer;
    }

    .flip-card {
      width: 540px;
      height: 360px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .flip-card.flip {
      transform: rotateY(180deg);
    }

    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 16px;
      overflow: hidden;
    }

    .flip-card-front img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .flip-card-back {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: rotateY(180deg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-content {
      text-align: center;
      padding: 40px;
    }

    .card-content h2 {
      font-size: 28px;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .card-content p {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 25px;
    }

    .question-button {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .question-button:hover {
      background: white;
      color: #5a3e8c;
      text-decoration: none;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .modal h3 {
      color: #5a3e8c;
      margin-bottom: 15px;
      font-size: 24px;
    }

    .modal p {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .textarea-container {
      position: relative;
      width: 100%;
    }

    .modal textarea {
      width: 100%;
      min-height: 100px;
      padding: 15px 50px 15px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
    }

    .modal textarea:focus {
      border-color: #5a3e8c;
      outline: none;
    }

    .voice-button {
      position: absolute;
      right: 10px;
      top: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: #5a3e8c;
      transition: all 0.2s ease;
      padding: 5px;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .voice-button:hover {
      background-color: #f0f0f0;
    }

    .voice-button.recording {
      color: #fff;
      background-color: #e74c3c;
      animation: pulse 1.5s infinite;
    }

    .voice-button.not-supported {
      color: #ccc;
      cursor: not-allowed;
    }

    @keyframes pulse {
      0% { 
        opacity: 1; 
        transform: scale(1);
      }
      50% { 
        opacity: 0.8; 
        transform: scale(1.1);
      }
      100% { 
        opacity: 1; 
        transform: scale(1);
      }
    }

    .voice-status {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      text-align: center;
      min-height: 16px;
    }

    .voice-status.recording {
      color: #e74c3c;
      font-weight: 600;
    }

    .voice-status.error {
      color: #e74c3c;
    }

    .voice-status.countdown {
      color: #f39c12;
      font-weight: 600;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .modal-button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-button.save {
      background-color: #5a3e8c;
      color: white;
    }

    .modal-button.save:hover {
      background-color: #4a3474;
    }

    .modal-button.cancel {
      background-color: #6c757d;
      color: white;
    }

    .modal-button.cancel:hover {
      background-color: #5a6268;
    }

    .success-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #f0fff4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
      padding: 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 2000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      display: none;
    }

    @media (max-width: 768px) {
      .flip-card {
        width: 100%;
        max-width: 400px;
        height: 270px;
      }
      
      .flip-cards-wrapper_top, .flip-cards-wrapper_bottom {
        flex-direction: column;
        align-items: center;
      }
      
      .card-content {
        padding: 20px;
      }
      
      .card-content h2 {
        font-size: 22px;
      }
      
      .container {
        margin-top: 100px;
      }
    }
  </style>
</head>
<body>
  <!-- Background Audio with Autoplay -->
  <audio id="backgroundAudio" autoplay>
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_kefkgsgymYSeXyU" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- Card Audio Elements -->
  <audio id="cardAudio-adverse" class="card-audio">
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_OrI1629xZEvNGSL" type="audio/mpeg">
  </audio>

  <audio id="cardAudio-neighbor" class="card-audio">
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_kaG7g6Skcfu7bno" type="audio/mpeg">
  </audio>

  <audio id="cardAudio-discriminate" class="card-audio">
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_jJcX7kxqvbpemI4" type="audio/mpeg">
  </audio>

  <audio id="cardAudio-stress" class="card-audio">
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_T2XinaQ2mkdyI3G" type="audio/mpeg">
  </audio>

  <!-- Modal Question Audio Elements -->
  <audio id="modalAudio-adverse" class="modal-audio">
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_pNZalIlMMuDDRy7" type="audio/mpeg">
  </audio>

  <audio id="modalAudio-neighbor" class="modal-audio">
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_YTt5VAt78LB0uQr" type="audio/mpeg">
  </audio>

  <audio id="modalAudio-discriminate" class="modal-audio">
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_OSm7vlTvMV1SCel" type="audio/mpeg">
  </audio>

  <audio id="modalAudio-stress" class="modal-audio">
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_6vZClDc1eZ7HsJI" type="audio/mpeg">
  </audio>

  <!-- Previous button -->
  <a href="{% url 'neg_p2' %}" class="before-button">
    ‚Üê Previous
  </a>

  <!-- Next button (hidden initially) -->
  <div class="next-button-container" id="nextButtonContainer" style="display: none;">
    <a href="{% url 'neg_p4' %}" class="next-button-overlay" id="nextButton">
      Next ‚Üí
    </a>
  </div>

  <!-- Hidden audio element for sound effect -->
  <audio id="successSoundEffect" class="hidden-audio" preload="auto">
    <source src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_6UG7Rt7QKA7N8oH" type="audio/mpeg">
  </audio>

  <!-- Success message -->
  <div id="successMessage" class="success-message">
    Your response has been saved!
  </div>

  <div class="container">
     <div class="intro-text">
      <b style="font-size: 1.2em;">Click on the images below to learn more about negative events!</b><br>
  On the back of each card, you'll find a fun question you can click on to share your own experiences.<br><br>
  Once you've answered all the cards, the "Next" button will appear.
  </div>

    <div class="flip-cards-wrapper_top">
      <div class="flip-card-container" data-category="adverse">
        <div class="flip-card">
          <div class="flip-card-front">
            <img src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_IC3UZQlAHEKMErz" 
                 alt="Adverse Events">
          </div>
          <div class="flip-card-back">
            <div class="card-content">
              <h2>Adverse Events</h2>
              <p>Over 50% of adolescents report experiencing or witnessing violent events. These often happen at school or at home. Many other kids will experience adversities related to not having basic resources, such as a home, food, or clean clothes.</p>
              <button class="question-button" onclick="openModal('adverse')">
                Have you ever experienced an adversity?
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="flip-card-container" data-category="neighbor">
        <div class="flip-card">
          <div class="flip-card-front">
            <img src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_WuveDhj1SogwDJQ" 
                 alt="Neighborhood Issues">
          </div>
          <div class="flip-card-back">
            <div class="card-content">
              <h2>Neighborhood Issues</h2>
              <p>Negative events can also happen in the neighborhood, such as witnessing a shooting, seeing two people fight, or not having safe spaces, like parks or libraries. Have you ever had neighborhood issues?</p>
              <button class="question-button" onclick="openModal('neighbor')">
                Have you ever had neighborhood issues?
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="flip-cards-wrapper_bottom">
      <div class="flip-card-container" data-category="discriminate">
        <div class="flip-card">
          <div class="flip-card-front">
            <img src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_ye9Gh83j3n7Vcgj" 
                 alt="Discrimination">
          </div>
          <div class="flip-card-back">
            <div class="card-content">
              <h2>Discrimination</h2>
              <p>Adolescents still experience discrimination. <br> It could be something someone has directly said to you or a feeling you get from being in a place you know you're not wanted.</p>
              <button class="question-button" onclick="openModal('discriminate')">
                Have you ever been discriminated against?
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="flip-card-container" data-category="stress">
        <div class="flip-card">
          <div class="flip-card-front">
            <img src="https://illinois.qualtrics.com/ControlPanel/File.php?F=F_trpuTd4R8hEs8O6" 
                 alt="Stressors and Hassles">
          </div>
          <div class="flip-card-back">
            <div class="card-content">
              <h2>Stressors and Hassles</h2>
              <p>Everyday we experience different stressors or hassles. This could be getting a bad grade on a test, having an argument with family, or a problem with a friend.</p>
              <button class="question-button" onclick="openModal('stress')">
                Have you experienced any stressors that have impacted how you feel?
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for responses -->
  <div id="responseModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">Share Your Experience</h3>
      <p id="modalPrompt"></p>
      <div class="textarea-container">
        <textarea id="responseText" placeholder="Type your response here or click the microphone to speak..."></textarea>
        <button type="button" class="voice-button" id="voiceButton" title="Click to start voice recording">
          <span id="voiceIcon">üé§</span>
        </button>
      </div>
      <div class="voice-status" id="voiceStatus"></div>
      <div class="modal-buttons">
        <button type="button" class="modal-button cancel" onclick="closeModal()">Cancel</button>
        <button type="button" class="modal-button save" onclick="saveUserResponse()">Save Response</button>
      </div>
    </div>
  </div>

  <script>
    // Direct localStorage functions (consistent with pos_p3)
    function markComplete(pageId) {
      try {
        localStorage.setItem('completed_' + pageId, 'true');
        localStorage.setItem('completed_' + pageId + '_timestamp', Date.now().toString());
        return true;
      } catch (e) {
        console.error('Error saving completion status:', e);
        return false;
      }
    }

    function isComplete(pageId) {
      try {
        return localStorage.getItem('completed_' + pageId) === 'true';
      } catch (e) {
        console.error('Error checking completion status:', e);
        return false;
      }
    }

    function saveResponse(category, response) {
      try {
        // Get current data
        let data = JSON.parse(localStorage.getItem('renew_study_data') || '{}');
        
        // Ensure required structures exist
        if (!data.responses) data.responses = {};
        if (!data.responses.negative_events) data.responses.negative_events = {};
        
        // Save the response
        data.responses.negative_events[category] = response;
        
        // Save back to localStorage
        localStorage.setItem('renew_study_data', JSON.stringify(data));
        return true;
      } catch (e) {
        console.error('Error saving response:', e);
        return false;
      }
    }

    function getResponses() {
      try {
        const data = JSON.parse(localStorage.getItem('renew_study_data') || '{}');
        return data.responses?.negative_events || {};
      } catch (e) {
        console.error('Error getting responses:', e);
        return {};
      }
    }

    function markSectionComplete(sectionId) {
      try {
        let data = JSON.parse(localStorage.getItem('renew_study_data') || '{}');
        
        if (!data.completed_sections) data.completed_sections = [];
        if (!data.progress) data.progress = {};
        
        // Mark section as complete
        if (!data.completed_sections.includes(sectionId)) {
          data.completed_sections.push(sectionId);
        }
        data.progress[sectionId] = true;
        
        localStorage.setItem('renew_study_data', JSON.stringify(data));
        return true;
      } catch (e) {
        console.error('Error marking section complete:', e);
        return false;
      }
    }

    // Function to play success sound effect
    function playSuccessSound() {
      const soundEffect = document.getElementById('successSoundEffect');
      if (soundEffect) {
        // Reset audio to beginning in case it was played before
        soundEffect.currentTime = 0;
        soundEffect.play().catch(error => {
          console.log('Sound effect autoplay failed (browser policy):', error);
          // Sound effect is just enhancement, continue normally if blocked
        });
      }
    }

    // Function to show next button with motivational animation
    function showNextButtonMotivational() {
      const nextButtonContainer = document.getElementById('nextButtonContainer');
      const nextButton = document.getElementById('nextButton');
      
      if (nextButtonContainer && nextButton) {
        // Show the container
        nextButtonContainer.style.display = 'block';
        
        // Check if both animation AND sound have already been shown for this page
        const specialEffectsShown = localStorage.getItem('neg_p3_special_effects_shown');
        
        if (!specialEffectsShown) {
          // First time showing - play both the motivational animation AND sound effect
          playSuccessSound();
          
          // Make sure no other classes are on the button first
          nextButton.classList.remove('next-button-pulse', 'visible');
          nextButton.classList.add('next-button-motivational');
          
          // Mark both animation and sound as shown immediately
          localStorage.setItem('neg_p3_special_effects_shown', 'true');
          
          // After initial animation completes, switch to subtle pulse
          setTimeout(() => {
            nextButton.classList.remove('next-button-motivational');
            nextButton.classList.add('next-button-pulse', 'visible');
          }, 1200);
        } else {
          // Special effects already shown before - show with subtle pulse immediately
          // NO sound effect and NO motivational animation
          nextButton.classList.remove('next-button-motivational');
          nextButton.classList.add('next-button-pulse', 'visible');
        }
      }
    }

    // Voice recognition variables
    let recognition = null;
    let isRecording = false;
    let silenceTimer = null;
    let silenceCountdown = null;
    let lastSpeechTime = null;
    const SILENCE_THRESHOLD = 4000;
    const COUNTDOWN_DURATION = 3000;
    
    const voiceButton = document.getElementById('voiceButton');
    const voiceIcon = document.getElementById('voiceIcon');
    const voiceStatus = document.getElementById('voiceStatus');
    const responseText = document.getElementById('responseText');

    // Check for speech recognition support
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      
      recognition.onstart = function() {
        isRecording = true;
        voiceButton.classList.add('recording');
        voiceIcon.textContent = '‚èπÔ∏è';
        voiceButton.title = 'Click to stop recording or wait for auto-stop';
        voiceStatus.textContent = 'Listening... Speak now!';
        voiceStatus.classList.add('recording');
        lastSpeechTime = Date.now();
        startSilenceDetection();
      };
      
      recognition.onresult = function(event) {
        let finalTranscript = '';
        
        lastSpeechTime = Date.now();
        clearSilenceTimer();
        startSilenceDetection();
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          }
        }
        
        if (finalTranscript) {
          const currentText = responseText.value;
          const newText = currentText + (currentText ? ' ' : '') + finalTranscript;
          responseText.value = newText;
        }
      };
      
      recognition.onerror = function(event) {
        stopRecording();
        voiceStatus.classList.add('error');
        voiceStatus.textContent = 'Voice recognition error. Try again.';
        setTimeout(() => {
          voiceStatus.textContent = '';
          voiceStatus.classList.remove('error');
        }, 4000);
      };
      
      recognition.onend = function() {
        stopRecording();
      };
      
      function startSilenceDetection() {
        clearSilenceTimer();
        silenceTimer = setTimeout(() => {
          startCountdown();
        }, SILENCE_THRESHOLD);
      }
      
      function startCountdown() {
        let remainingTime = 3;
        voiceStatus.classList.remove('recording');
        voiceStatus.classList.add('countdown');
        
        const updateCountdown = () => {
          if (remainingTime > 0) {
            voiceStatus.textContent = `Auto-stopping in ${remainingTime}...`;
            remainingTime--;
            silenceCountdown = setTimeout(updateCountdown, 1000);
          } else {
            recognition.stop();
          }
        };
        updateCountdown();
      }
      
      function clearSilenceTimer() {
        if (silenceTimer) clearTimeout(silenceTimer);
        if (silenceCountdown) clearTimeout(silenceCountdown);
        voiceStatus.classList.remove('countdown');
        if (isRecording) voiceStatus.classList.add('recording');
      }
      
      function stopRecording() {
        isRecording = false;
        voiceButton.classList.remove('recording');
        voiceIcon.textContent = 'üé§';
        voiceButton.title = 'Click to start voice recording';
        voiceStatus.classList.remove('recording', 'countdown');
        clearSilenceTimer();
      }
      
      voiceButton.addEventListener('click', function() {
        if (isRecording) {
          recognition.stop();
        } else {
          try {
            recognition.start();
          } catch (error) {
            voiceStatus.textContent = 'Error starting voice recognition.';
            voiceStatus.classList.add('error');
          }
        }
      });
    } else {
      voiceButton.classList.add('not-supported');
      voiceButton.disabled = true;
      voiceStatus.textContent = 'Voice recognition not available';
    }

    // Function to stop all audio
    function stopAllAudio() {
      // Stop background audio
      const backgroundAudio = document.getElementById('backgroundAudio');
      if (backgroundAudio) {
        backgroundAudio.pause();
        backgroundAudio.currentTime = 0;
      }
      
      // Stop all card audio
      document.querySelectorAll('.card-audio').forEach(function(audio) {
        audio.pause();
        audio.currentTime = 0;
      });
      
      // Stop all modal audio
      document.querySelectorAll('.modal-audio').forEach(function(audio) {
        audio.pause();
        audio.currentTime = 0;
      });
    }

    // Function to play audio for a specific card
    function playCardAudio(category) {
      // Stop all audio first to prevent overlap
      stopAllAudio();
      
      // Play the audio for this card
      const cardAudio = document.getElementById('cardAudio-' + category);
      if (cardAudio) {
        cardAudio.play().catch(error => {
          console.log('Card audio play failed:', error);
        });
      }
    }

    // Flip card functionality
    document.querySelectorAll('.flip-card-container').forEach(function(container) {
      container.addEventListener('click', function(e) {
        if (e.target.classList.contains('question-button')) {
          return;
        }
        
        var card = this.querySelector('.flip-card');
        var isFlipping = !card.classList.contains('flip');
        card.classList.toggle('flip');
        
        // Play audio when flipping to the back (when card is being flipped)
        if (isFlipping) {
          const category = this.getAttribute('data-category');
          if (category) {
            playCardAudio(category);
          }
        }
      });
    });

    // Modal functionality
    const modal = document.getElementById('responseModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalPrompt = document.getElementById('modalPrompt');
    let currentCategory = '';

    const prompts = {
      adverse: "Have you ever experienced an adversity? If so, fill in the blank below to tell us about it or just report 'Yes' or 'No'.",
      neighbor: "Have you ever had any neighborhood issues? If so, fill in the blank below to tell us about it or just report 'Yes' or 'No'.",
      discriminate: "Have you ever been discriminated against? If so, fill in the blank below to tell us about it or just report 'Yes' or 'No'.",
      stress: "Have you experienced any stressors that have impacted how you feel? If so, fill in the blank below to tell us about it or just report 'Yes' or 'No'."
    };

    const titles = {
      adverse: "Adverse Events",
      neighbor: "Neighborhood Issues", 
      discriminate: "Discrimination",
      stress: "Stressors and Hassles"
    };

    // Track responses
    let completedResponses = new Set();
    const totalCategories = 4;

    function openModal(category) {
      currentCategory = category;
      modalTitle.textContent = titles[category];
      modalPrompt.textContent = prompts[category];
      
      // Pre-fill with existing response if available
      const existingResponses = getResponses();
      const existingResponse = existingResponses[category] || '';
      responseText.value = existingResponse;
      
      modal.style.display = 'block';
      
      // Reset voice status
      voiceStatus.textContent = '';
      voiceStatus.classList.remove('recording', 'error');
      
      // Stop any ongoing recording
      if (recognition && isRecording) {
        recognition.stop();
      }
      
      // Stop all audio and play modal audio
      stopAllAudio();
      const modalAudio = document.getElementById('modalAudio-' + category);
      if (modalAudio) {
        modalAudio.play().catch(error => {
          console.log('Modal audio play failed:', error);
        });
      }
    }

    function closeModal() {
      modal.style.display = 'none';
      
      // Stop any ongoing recording
      if (recognition && isRecording) {
        recognition.stop();
      }
      
      // Reset voice status
      voiceStatus.textContent = '';
      voiceStatus.classList.remove('recording', 'error');
      
      // Stop all audio when modal closes
      stopAllAudio();
    }

    function saveUserResponse() {
      const response = responseText.value.trim();
      
      if (!response) {
        alert('Please enter a response or type "None"');
        return;
      }

      // Stop any ongoing recording
      if (recognition && isRecording) {
        recognition.stop();
      }
      
      // Save response using the same structure as pos_p3
      if (saveResponse(currentCategory, response)) {
        completedResponses.add(currentCategory);
        
        closeModal();
        showSuccessMessage();
        
        // Show next button if all categories completed - with motivational animation!
        if (completedResponses.size >= totalCategories) {
          showNextButtonMotivational(); // Use the enhanced version
          markComplete('neg_p3');
          markSectionComplete('negative_events');
        }
      } else {
        alert('Error saving response. Please try again.');
      }
    }

    function showSuccessMessage() {
      const successMsg = document.getElementById('successMessage');
      successMsg.style.display = 'block';
      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 1000);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target == modal) {
        closeModal();
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Handle background audio autoplay
      const audio = document.getElementById('backgroundAudio');
      if (audio) {
        // Try to play audio
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
          playPromise.then(() => {
            // Autoplay started successfully
            console.log('Background audio playing');
          }).catch(error => {
            // Autoplay was prevented - try to play on first user interaction
            console.log('Autoplay prevented, waiting for user interaction');
            
            const playOnInteraction = () => {
              audio.play().catch(e => console.log('Audio play failed:', e));
              // Remove listeners after first play
              document.removeEventListener('click', playOnInteraction);
              document.removeEventListener('touchstart', playOnInteraction);
              document.removeEventListener('keydown', playOnInteraction);
            };
            
            document.addEventListener('click', playOnInteraction);
            document.addEventListener('touchstart', playOnInteraction);
            document.addEventListener('keydown', playOnInteraction);
          });
        }
      }
      
      // Load existing responses
      const existingResponses = getResponses();
      completedResponses = new Set(Object.keys(existingResponses));
      
      // Show next button ONLY if all 4 categories have responses
      if (completedResponses.size >= totalCategories) {
        showNextButtonMotivational();
      }
    });
    </script>
</body>
</html>